---
title: "lab19: Pertussis Mini Project"
author: "Meha Thakur PID A16020450"
format: pdf
toc: TRUE
---
Pertussis (whooping cough) is a highly infectious lung infection caused by the bacteria *B. Pertussis*. The CDC tracks case numbers in the US and makes this data available online: 
https://www.cdc.gov/pertussis/php/surveillance/pertussis-cases-by-year.html?CDC_AAref_Val=https://www.cdc.gov/pertussis/surv-reporting/cases-by-year.html

## 1. Investigating pertussis cases by year - warm up

> Q1. With the help of the R “addin” package datapasta assign the CDC pertussis case number data to a data frame called cdc and use ggplot to make a plot of cases numbers over time.


Theres no link to a csv file, so we need to scrape this data from the webpage. Use datapasta package. Copy the data table you want from a website, then click addins on the top menu, and paste as dataframe in the 'datapasta' section.

```{r, include=FALSE}
library(datapasta)

cdc<-data.frame(
                               year = c(1922L,1923L,1924L,1925L,1926L,
                                        1927L,1928L,1929L,1930L,1931L,1932L,
                                        1933L,1934L,1935L,1936L,1937L,1938L,
                                        1939L,1940L,1941L,1942L,1943L,
                                        1944L,1945L,1946L,1947L,1948L,1949L,
                                        1950L,1951L,1952L,1953L,1954L,1955L,
                                        1956L,1957L,1958L,1959L,1960L,
                                        1961L,1962L,1963L,1964L,1965L,1966L,
                                        1967L,1968L,1969L,1970L,1971L,1972L,
                                        1973L,1974L,1975L,1976L,1977L,1978L,
                                        1979L,1980L,1981L,1982L,1983L,
                                        1984L,1985L,1986L,1987L,1988L,1989L,
                                        1990L,1991L,1992L,1993L,1994L,1995L,
                                        1996L,1997L,1998L,1999L,2000L,
                                        2001L,2002L,2003L,2004L,2005L,2006L,
                                        2007L,2008L,2009L,2010L,2011L,2012L,
                                        2013L,2014L,2015L,2016L,2017L,2018L,
                                        2019L,2020L,2021L,2022L,2023L),
       cases = c(107473,164191,165418,152003,
                                        202210,181411,161799,197371,166914,
                                        172559,215343,179135,265269,180518,
                                        147237,214652,227319,103188,183866,
                                        222202,191383,191890,109873,133792,
                                        109860,156517,74715,69479,120718,68687,
                                        45030,37129,60886,62786,31732,28295,
                                        32148,40005,14809,11468,17749,
                                        17135,13005,6799,7717,9718,4810,3285,
                                        4249,3036,3287,1759,2402,1738,
                                        1010,2177,2063,1623,1730,1248,1895,
                                        2463,2276,3589,4195,2823,3450,4157,
                                        4570,2719,4083,6586,4617,5137,
                                        7796,6564,7405,7298,7867,7580,9771,
                                        11647,25827,25616,15632,10454,13278,
                                        16858,27550,18719,48277,28639,
                                        32971,20762,17972,18975,15609,18617,
                                        6124,2116,3044,7063)
     )
  
  
```

make graph - cases over time 
```{r}
library(ggplot2)

ggplot(cdc, aes(year, cases))+
  geom_line()+
  geom_point(size=0.8)
  
```
> Q2. Using the ggplot geom_vline() function add lines to your previous plot for the 1946 introduction of the wP (whole cell) vaccine, deployment in 1947, and the 1996 switch to aP vaccine (see example in the hint below). Add a line for 2020, also.

```{r}
ggplot(cdc, aes(year, cases))+
  geom_line()+
  geom_point(size=0.8)+
  geom_vline(xintercept=1947, col="blue", linetype="dashed")+
  geom_vline(xintercept=1996, col="red",linetype="dashed")+
  geom_vline(xintercept=2020, col="darkgreen",linetype="dashed")
  
  


```
> Q3. Describe what happened after the introduction of the aP vaccine? Do you have a possible explanation for the observed trend?

Why is there a spike in the mid-2000s? Anti-vaccine movement perhaps? Introduction of social media in the 2010s was able to spread anti-vacicne rhetoric. Maybe Ap and Wp vaccines have a fundamental difference in lasting immunity, Ap perhaps doesn't have as long-lasting of an immunity as Wp hence the need for boosters that not everyone may get. 

**Why does aP induced protection wane faster than Wp?**

## CMI-PB project

The CMI-Pertussis Boost (PB) project focusses on gathering data for this topic,. What is disctinct between aP and wP individuals over time. Data is available in a JSON format, can be read in with `read_jason()` in the **jsonlite** package.

```{r}
library(jsonlite)

subject<-read_json("https://www.cmi-pb.org/api/v5_1/subject",
                   simplifyVector = TRUE)
head(subject)
```

> Q4. How many "subjects" are in this dataset

```{r}
nrow(subject)
```
ans: 172 subjects

> Q5. How many wP and aP primed subjects are there in this dataset

```{r}
table(subject$infancy_vac)
```

There are 87 aP and 85 wP subjects in this dataset.

> Q6. What is the `biological sex` and `race` breakdown of these subjects - is this representative of a population

```{r}
table(subject$race,subject$biological_sex)
```
overrepresentation of white females in this dataset - not representative of the US dataset.

Lets read more tables from the CBI-PB databse API. Specimen IDs stay consistent between dataframes
```{r}
specimen<-read_json("http://cmi-pb.org/api/v5_1/specimen", simplifyVector = TRUE)
ab_titer<-read_json("http://cmi-pb.org/api/v5_1/plasma_ab_titer", simplifyVector = TRUE)
```

Want to take subject and speciment table, and merge them using `inner_join()` or `full_join()`. inner join takes whats common between the two datasets, vs full join will just add everything even if data is missing form one dataset. We want to use inner join in `dplyr`
```{r}
library(dplyr)

meta<-inner_join(subject,specimen)
head(meta) #notice it says joined by suject ID, since that is the common column between the two dfs

#also want to join the antibody titer table

ab_data<-inner_join(meta,ab_titer) #this is quite a big dataframe now.
```

> Q7. how many different antibody isotypes are there 

```{r}
unique(ab_data$isotype)
```

There are 6 isotypes

> Q8. How many different antigens are there 

```{r}
unique(ab_data$antigen)

```

There are 16 types of antigens. Measles can be considered a negative control?

> Q9. Lets plot MFI vs. antigen

```{r}
ggplot(ab_data, aes(MFI, antigen))+
  geom_boxplot()
  
  
```


## Focus on IgG

IgG is crucial for long-term immunity and respondign to bacterial/viral infections

```{r}
igg_ab<-ab_data %>%
  filter(isotype=="IgG")

ggplot(igg_ab,aes(MFI_normalised,antigen))+
  geom_boxplot()
```

### Diffrence between aP and wP?

We can colour by infancy_vac
```{r}
ggplot(igg_ab,aes(MFI_normalised,antigen,col=infancy_vac))+
  geom_boxplot()
```

We can also facet by aP vs. wP column

```{r}
ggplot(igg_ab,aes(MFI_normalised,antigen,col=infancy_vac))+
  geom_boxplot()+
  facet_wrap(~infancy_vac)
```

## Time course analysis 

look at visits for each patient as a proxy for time. Will use visits 1-8 since some of the later ones aren't as complete
```{r}
table(ab_data$visit)

vis<-igg_ab%>%
  filter(visit%in% 1:8)

ggplot(vis,aes(MFI_normalised,antigen,col=infancy_vac))+
  geom_boxplot()+
  facet_wrap(~visit,nrow=2)
```

Some antigens like FIM2/3 appears to increase over time, FIM2/3 refers to Fimbriae 2 and 3 which are antigens derived from B. Pertussis bacterium - causative agent of whooping cough. These are delivered in the vaccines.

## Time course of PT 

```{r}

PT_ab<-ab_data %>%
  filter(isotype=="IgG")%>%
  filter(antigen=="PT")%>%
  filter(dataset=="2021_dataset")

ggplot(PT_ab,aes(MFI_normalised,antigen,col=infancy_vac))+
  geom_boxplot()+
  facet_wrap(~visit,nrow=2)

```
Over time, wP PT antigen levels appear to take over aP, indicating that the effects of wP are longer lasting than aP.

```{r}
ggplot(PT_ab,aes(planned_day_relative_to_boost,MFI_normalised,
                 col=infancy_vac, 
                 group=subject_id))+
  geom_point()+
  geom_line()+
  geom_vline(xintercept = 14,linetype="dashed")

```

This plot shows that around 14 days post booster shot, immunity peaks for both vaccine types. OVer time, aP immunity degrades faster than wP. It also appears that wP MFI peaks much higher than aP MFI. 


## System setup - prints out information about my setup to run this analysis. 

```{r}
sessionInfo()
```





